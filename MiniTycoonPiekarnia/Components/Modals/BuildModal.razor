@implements IDisposable

<div class="modal-overlay" @onclick="Close"></div>

<div class="modal" @onclick:stopPropagation>
    <h2>Buduj na polu (@Tile.X, @Tile.Y)</h2>

    <div class="building-options">
        <div class="building-card" @onclick="() => TryBuild(BuildingType.Oven)">
            <img src="images/building/piec.png" alt="Piec" />
            <div class="label">Piec</div>
            <div class="price">200 zł</div>
        </div>
        <div class="building-card" @onclick="() => TryBuild(BuildingType.Shelf)">
            <img src="images/building/polka.png" alt="Półka" />
            <div class="label">Półka</div>
            <div class="price">100 zł</div>
        </div>
        <div class="building-card" @onclick="() => TryBuild(BuildingType.Website)">
            <img src="images/building/witryna.png" alt="Witryna chłodnicza" />
            <div class="label">Witryna chłodnicza</div>
            <div class="price">150 zł</div>
        </div>
    </div>
    <div class="rotation-controls">
        <button @onclick="RotateLeft">⟲ Obróć</button>
        <span>@rotation°</span>
    </div>

<ErrorPopup Message="@popup.Message" Visible="@popup.Visible" FadeOut="@popup.FadeOut" />
</div>

@code {
    [Parameter] public Tile Tile { get; set; } = null!;
    [Parameter] public EventCallback OnClose { get; set; }

    private ErrorPopupController popup = new();
    private int rotation = 0;

    protected override void OnInitialized() => GameState.OnChange += StateHasChanged;
    public void Dispose() => GameState.OnChange -= StateHasChanged;

    private void Close() => ModalService.CloseModal();

    private async Task TryBuild(BuildingType type)
    {
        var cost = GetBuildingCost(type);
        var success = GameState.Building.BuildBuilding(Tile.X, Tile.Y, type, cost, rotation);

        if (!success)
        {
            await popup.ShowError("Za mało pieniędzy lub budynek już istnieje.");
            return;
        }

        await GameState.SaveGameAsync();
        ModalService.CloseModal();
    }

    private decimal GetBuildingCost(BuildingType building) => building switch
    {
        BuildingType.Oven => 200m,
        BuildingType.Shelf => 100m,
        BuildingType.Website => 150m,
        _ => 0m
    };

    private void RotateLeft() => rotation = (rotation + 90) % 360;
}
